import streamlit as st
import google.generativeai as genai
from modules.comparator import TextComparator

def get_available_models(api_key):
    """‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Key ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á"""
    try:
        genai.configure(api_key=api_key)
        all_models = []
        for m in genai.list_models():
            if 'generateContent' in m.supported_generation_methods:
                all_models.append(m.name)
        return all_models
    except:
        return []

def get_ai_correction_stream(api_key, text, model_name, progress_bar, stream_box):
    try:
        genai.configure(api_key=api_key)
        
        # ‡∏õ‡∏¥‡∏î Safety Filter (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î Stream ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏™‡∏∞‡∏î‡∏∏‡∏î)
        safety_settings = [
            {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
            {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
        ]
        
        model = genai.GenerativeModel(model_name, safety_settings=safety_settings)
        
        prompt = f"""
        Act as a professional proofreader. 
        Please correct the spelling, grammar, and punctuation errors in the following text (Thai and English).
        Maintain the original tone and style. 
        RETURN ONLY THE CORRECTED TEXT without any explanation or markdown formatting.
        
        Text to correct:
        {text}
        """
        
        # stream=True ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        response = model.generate_content(prompt, stream=True)
        
        full_text = ""
        total_len = len(text) if len(text) > 0 else 1
        
        for chunk in response:
            if chunk.text:
                chunk_text = chunk.text
                full_text += chunk_text
                
                # 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï % ‡πÉ‡∏ô‡∏´‡∏•‡∏≠‡∏î
                current_len = len(full_text)
                progress = min(current_len / total_len, 0.99)
                progress_bar.progress(progress, text=f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå... ({int(progress*100)}%)")
                
                # 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î‡πÜ ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á (Live Preview)
                # ‡πÉ‡∏ä‡πâ markdown ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
                stream_box.markdown(
                    f"""
                    <div style="
                        background-color: #f0f2f6; 
                        padding: 10px; 
                        border-radius: 5px; 
                        font-family: monospace; 
                        color: #555;
                        font-size: 0.8rem;
                        height: 150px; 
                        overflow-y: auto;
                        border: 1px dashed #ccc;">
                        {full_text}
                    </div>
                    """, 
                    unsafe_allow_html=True
                )

        # ‡∏à‡∏ö‡∏á‡∏≤‡∏ô: ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 100%
        progress_bar.progress(1.0, text="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
        return full_text.strip()
        
    except Exception as e:
        if "429" in str(e):
            return "API_ERROR: ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° (Quota Exceeded)"
        return f"API_ERROR: {str(e)}"

def render_spell_check_mode():
    col_setup, col_result = st.columns([1, 1])
    
    with col_setup:
        st.markdown("### 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)")
        
        api_key = None
        if "GEMINI_API_KEY" in st.secrets:
            api_key = st.secrets["GEMINI_API_KEY"]
            st.success("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö API Key ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß")
        else:
            api_key = st.text_input("üîë Gemini API Key", type="password")

        selected_model = None
        if api_key:
            model_options = get_available_models(api_key)
            if model_options:
                default_idx = 0
                for i, name in enumerate(model_options):
                    # Logic ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Default Model
                    if "flash" in name and "exp" not in name:
                        default_idx = i; break
                    elif "gemini-pro" in name and "exp" not in name:
                        default_idx = i
                selected_model = st.selectbox("ü§ñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å AI Model", model_options, index=default_idx)
            else:
                st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•")
        
        st.markdown("---")
        text_input = st.text_area("‚úçÔ∏è ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (Original Text)", height=400, placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")
        
        btn_check = st.button("‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô (Start)", type="primary", use_container_width=True, disabled=(not api_key or not text_input or not selected_model))

    with col_result:
        st.markdown("### 2. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô (AI Suggestion)")

        if btn_check and api_key and text_input and selected_model:
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Progress Bar ‡πÅ‡∏•‡∏∞ Live Text
            st.caption("üöÄ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:")
            progress_bar = st.progress(0, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI...")
            stream_box = st.empty() # ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏£‡∏≠‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î
            
            try:
                # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Stream
                corrected_text = get_ai_correction_stream(api_key, text_input, selected_model, progress_bar, stream_box)
                
                # ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á Preview ‡∏ó‡∏¥‡πâ‡∏á (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÇ‡∏ä‡∏ß‡πå Diff ‡∏™‡∏ß‡∏¢‡πÜ ‡πÅ‡∏ó‡∏ô)
                stream_box.empty() 
                # ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πá‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö
                
                progress_bar.empty() # ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏≠‡∏î‡πÇ‡∏´‡∏•‡∏î

                if corrected_text.startswith("API_ERROR:"):
                    st.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI:")
                    st.error(corrected_text.replace("API_ERROR:", ""))
                else:
                    original_lines = text_input.splitlines()
                    corrected_lines = corrected_text.splitlines()

                    comparator = TextComparator()
                    raw_html = comparator.generate_diff_html(original_lines, corrected_lines, mode="all")
                    final_html = comparator.get_final_display_html(raw_html)

                    st.success("‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
                    st.markdown('<div class="css-card">', unsafe_allow_html=True)
                    import streamlit.components.v1 as components
                    components.html(final_html, height=600, scrolling=True)
                    st.markdown('</div>', unsafe_allow_html=True)
                    
                    with st.expander("üìÑ ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß (Plain Text)"):
                        st.code(corrected_text, language=None)
                        
            except Exception as e:
                st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
